#!/usr/bin/env python3
import os
import time
import socket
import sys
import platform
import subprocess
from datetime import datetime
from pathlib import Path
from modules.bluetooth_module import BluetoothModule
from modules.wifi_module import WifiModule
from modules.rf_module import RFModule
from modules.automobile_module import AutomobileModule
from modules.ics_module import ICSModule

# Color codes
GREEN = '\033[32m'
YELLOW = '\033[33m'
RED = '\033[31m'
BLUE = '\033[34m'
MAGENTA = '\033[35m'
CYAN = '\033[36m'
LIGHTCYAN_EX = '\033[96m'
BLACK = '\x1b[30m'
RESET = '\033[0m'

# Speed Conf
ANIMATION_SPEED = 0.005

### Color Status ###
def print_status(message: str) -> None:
    """Print status messages"""
    print(f"{GREEN}[‚úö]{RESET} {message}")

def print_warning(message: str) -> None:
    """Print warning messages"""
    print(f"{YELLOW}[‚ùïÔ∏è]{RESET} {message}")

def print_error(message: str) -> None:
    """Print error messages"""
    print(f"{RED}[‚îÅ]{RESET} {message}")

### Text Animation ###
def text_animation():
    banner_text = f"""{MAGENTA}
  _  _  _   _    __    ____  _  _  ____  ___  ____  ____  ____ {RED}
 ( \/ )( )_( )  /__\  (  _ \( \/ )( ___)/ __)(_  _)( ___)(  _ \\{MAGENTA}
  )  (  ) _ (  /(__)\  )   / \  /  )__) \__ \  )(   )__)  )   /{RED}
 (_/\_)(_) (_)(__)(__)(_)\_)  \/  (____)(___/ (__) (____)(_)\_)
    {RESET}"""
    for char in banner_text:
        print(char, end='', flush=True)
        time.sleep(ANIMATION_SPEED)
    print(f"\n{CYAN} >>> Extended Reconnaissance & Exploitation Toolkit For Newbies <<<{RESET}")
    print(f"{GREEN}| GitHub:{RESET}{YELLOW} @n3tworkh4x |{RESET}{MAGENTA} Ko-fi{YELLOW}(Donation):{RESET}{GREEN} https://ko-fi.com/n3twork |")
    print(f"\t\t{YELLOW}‚Ñ¨ y{GREEN} ùìùùìÆùìΩùîÄùì∏ùìªùì¥({RED}G{YELLOW}H{GREEN}A{BLACK}N{RED}A)\t\t\t")
    print(f"{RED} Use only for authorized security testing!{RESET}")

global update

### Display Menu ###
def show_menu() -> None:
    text_animation()
    print(f"\n\t\t{LIGHTCYAN_EX} Ô∏ªËä´‚ïê‚îÄ‚îÄ‚îÄ {RED}üí• {YELLOW}(‚ñÄÃøƒπÃØ‚ñÄÃø Ãø)\t\t\t\n")
    print(f"{LIGHTCYAN_EX}  ‚áá‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‡≠®‡ßé‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚áâ")
    print(f"{GREEN}         {LIGHTCYAN_EX}üöÄ{RESET}{GREEN}   XHARVESTER -- MAIN MENU   {LIGHTCYAN_EX}üï∑{GREEN}")
    print(f"{LIGHTCYAN_EX}  ‚áá‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‡≠®‡ßé‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚áâ")
    print(f"{GREEN}\t[1]{MAGENTA} ·õí  {CYAN}BlueTooth")
    print(f"{GREEN}\t[2]{MAGENTA} üåê {CYAN}Wifi")
    print(f"{GREEN}\t[3]{MAGENTA} üöñ {CYAN}Automobile")
    print(f"{GREEN}\t[4]{MAGENTA} üì° {CYAN}Radio Frequency")
    print(f"{GREEN}\t[5]{MAGENTA} üèôÔ∏è  {CYAN}Industrial Control System - SCADA")
    print(f"{GREEN}\t[6]{MAGENTA} üõà  {CYAN}About")
    print(f"{LIGHTCYAN_EX}  ‚áá‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‡≠®‡ßé‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚áâ")
    print(f"{RED}\t [0] ‚úó Exit")
    print(f"{YELLOW}\t[99] üéÅ Update XHARVESTER")
    print(f"{LIGHTCYAN_EX}  ‚áá‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‡≠®‡ßé‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚áâ")

### Display About ###
def about() -> None:
    description = f"""
{RED}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
{YELLOW}Bio: {RESET}
{GREEN}     I am a 19-year-old skilled hacker and programmer with expertise in ICS/SCADA security,
{GREEN}     Wireless exploitation (Wi-Fi/Bluetooth/RF) & Automotive systems hacking.
{RED}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
{YELLOW}Tag Lines: {RESET}
{BLUE}    * Coding Is My Weapon, Hacking Is My Art
{BLUE}    * I Craft Backdoors & Close Loopholes
{BLUE}    * I Hack To Protect, Not To Destroy
{BLUE}    * I Love Crafting Backdoors ‚ûú]
{BLUE}    * Breaking Systems, Building Knowledge  
{BLUE}    * Pseudo Code: Print 'Our Democracy Has Been Hacked'
{BLUE}    * Plant Backdoors, Gain Power
{BLUE}    * When We Lose Our Principles, We Invite Chaos
{RED}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
{YELLOW}About: {RESET}
{CYAN}      xharvester is a specialized,{RESET}
{CYAN}      modular Python-based reconnaissance and eexploitation suite designed for security assessments of radio frequency (RF),{RESET}
{CYAN}      wireless (bluetooth & wifi),{RESET}
{CYAN}      industrial control system (SCADA),{RESET}
{CYAN}      and automotive systems.{RESET}
{CYAN}      It integrates multiple tools and scripts into a unified workflow for probing,{RESET}
{CYAN}      analyzing, and documenting findings from the physical and wireless world.{RESET}
{RED}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
{YELLOW}Version: {RESET}{BLUE}1.0{RESET}
{YELLOW}Date: {RESET}{BLUE}{datetime.now().strftime(f"%d/%m/%Y {YELLOW}Time:{RESET}{BLUE} %H:%M")}
{RED}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
"""
    print(description)
    
def clear_screen() -> None:
    os.system('cls' if os.name == 'nt' else 'clear')

def get_hostname() -> str:
    try:
        return socket.gethostname()
    except:
        return "unknown"

### Check for root privileges ###
def check_root() -> bool:
    """Check if the script is running with root privileges"""
    if platform.system() == "Windows":
        # On Windows, we need to check for administrator privileges
        try:
            import ctypes
            return ctypes.windll.shell32.IsUserAnAdmin() != 0
        except:
            return False
    else:
        # On Unix-like systems, check for root UID
        return os.geteuid() == 0

### Check if desktop launcher exists ###
def check_desktop_launcher() -> bool:
    """Check if desktop launcher exists and is accessible"""
    system = platform.system().lower()
    
    if system == "windows":
        # Check for Windows shortcut
        desktop = Path.home() / "Desktop" / "XHarvester.lnk"
        if desktop.exists():
            return True
        
        # Check other possible locations
        possible_locations = [
            Path.home() / "OneDrive" / "Desktop" / "XHarvester.lnk",
            Path(os.environ.get('USERPROFILE', '')) / "Desktop" / "XHarvester.lnk"
        ]
        
        for location in possible_locations:
            if location.exists():
                return True
                
    else:
        # Check for Linux desktop launcher
        desktop_file = Path.home() / ".local" / "share" / "applications" / "xharvester.desktop"
        if desktop_file.exists():
            return True
    return False

### Fix desktop launcher permissions ###
def fix_desktop_launcher():
    """Fix desktop launcher permissions and accessibility"""
    system = platform.system().lower()
    
    if system != "windows":
        # For Linux systems, ensure the desktop file is executable
        desktop_file = Path.home() / ".local" / "share" / "applications" / "xharvester.desktop"
        if desktop_file.exists():
            try:
                desktop_file.chmod(desktop_file.stat().st_mode | 0o755)
                print_status("Fixed desktop launcher permissions")
                return True
            except Exception as e:
                print_error(f"Failed to fix desktop launcher permissions: {e}")
                return False
    return False

def run_updater():
    clear_screen()
    # Check if updater script exists
    updater_script = "xharvester_updater.py"
    if not os.path.exists(updater_script):
        print_error(f"Updater script '{updater_script}' not found!")
        print_warning("Please ensure xharvester_updater.py is in the same directory.")
        input(f"\n{GREEN}Press Enter to continue„Éª„Éª„Éª{RESET}")
        return
    
    try:
        # Run the updater script
        print(f"{CYAN}\t\t\tRunning XHarvester updater„Éª„Éª„Éª\t\t\t\n")
        result = subprocess.run([sys.executable, updater_script], 
                              capture_output=True, text=True)
        
        if result.returncode == 0:
            print(f"{GREEN}\t\t\t[‚úö] Update completed successfully!\t\t\t\n")
            #update = datetime.now().strftime(f"{YELLOW}Last Updated: {BLUE}%d/%m/%Y")
            time.sleep(ANIMATION_SPEED)
        else:
            print(f"{GREEN}\t\t\t[‚úó] Update failed or was canceled.\t\t\t\n")
            time.sleep(ANIMATION_SPEED)
            
    except KeyboardInterrupt:
        print(f"{RED}\t\t\t[‚úó] Update canceled by user.\t\t\t\n")
    except Exception as e:
        print(f"{RED}\t\t\t[‚ùïÔ∏è] Error running updater: {e}\t\t\t\n")
    
    input(f"\n  {GREEN}Press Enter to continue„Éª„Éª„Éª")

def info() -> str:
    try:
        time_choice = input(f'{GREEN}  [‚ùî] Choose time stamps [Read Bio & About][default = 10]>>> ')
        if not time_choice:
            about()
            time.sleep(10)
        else:
            about()
            time.sleep(int(time_choice))
    except ValueError:
        mesg = f"{RED}\t\t\t[‚ùïÔ∏è] Invalid input. Using default time of 10 seconds.\t\t\t"
        for word in mesg:
            print(word, end="", flush=True)
            time.sleep(0.05)
    except (KeyboardInterrupt, EOFError):
        mesg = f"\n\t\t\t{MAGENTA}üö™üîô{YELLOW} Returning to menu„Éª„Éª„Éª\t\t\t"
        for word in mesg:
            print(word, end="", flush=True)
            time.sleep(0.05)
        

def main():
    # Check for root privileges
    if not check_root():
        warning = f"{YELLOW}[‚ùïÔ∏è] {RESET}{YELLOW}Please run xharvester with administrator/root privileges!\n"
        for word in warning:
            print(word, end='', flush=True)
            time.sleep(0.05)
        sys.exit(1)
    
    # ========== MAIN LOOP ========== #
    active = True
    while active:
        clear_screen()
        show_menu()
        try:
            choice = input(f"\n  [üíÄ] {GREEN}xharvester{YELLOW}@{RESET}{CYAN}{get_hostname()}{RESET}{RED}:{RESET}{GREEN}~{RESET}{YELLOW}$ ")
        except (KeyboardInterrupt, EOFError):
            terminator = f"\n\n\t\t\t{MAGENTA}[üíÄ]{RESET}{RED} Exiting„Éª„Éª„Éª\t\t\t\n\n"
            for word in terminator:
                print(word, end="", flush=True)
                time.sleep(0.05)
            break
            
        if choice == "0":
            closing_text = f"\n\t\t\t{MAGENTA}[üíÄ] {RESET}{RED}Closing The Program„Éª„Éª„Éª\t\t\t\n\n"
            for word in closing_text:
                print(word, end='', flush=True)
                time.sleep(0.05)
            active = False
            
        elif choice == "1":
            bluetooth = BluetoothModule()
            bluetooth.main()

        elif choice == "2":
            wifi = WifiModule()
            wifi.main()

        elif choice == "3":
            auto = AutomobileModule()
            auto.main()

        elif choice == '4':
            rf = RFModule()
            rf.main()

        elif choice == '5':
            ics = ICSModule()
            ics.main()

        elif choice == '6':
            info()

        elif choice == '99':
            run_updater()

        else:
            warning = f"\n\n\t\t\t{choice} is not a valid menu option!\n"
            print(warning)
            time.sleep(3)

if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt as err:
        varerr = f"\n\n\t\t\t{MAGENTA}{err}[üíÄ] {RESET}{RED}Process Terminated by User\n\n"
        for word in varerr:
            print(word, end="", flush=True)
            time.sleep(0.05)